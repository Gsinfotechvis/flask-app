---
- name: ğŸš€ Full Flask App Deployment on Minikube (WSL)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    kubeconfig_path: "/home/ubuntu/.kube/config"

  tasks:
    - name: ğŸŸ¢ Ensure Minikube is running
      shell: |
        if ! minikube status | grep -q "Running"; then
          echo "Starting Minikube..."
          minikube start --driver=docker --memory=3072mb
        else
          echo "âœ… Minikube already running"
        fi
      args:
        executable: /bin/bash
      register: minikube_status
      ignore_errors: yes

    - name: ğŸ§© Set Docker & Minikube environment
      shell: |
        eval $(minikube docker-env)
        export KUBECONFIG="{{ kubeconfig_path }}"
        echo "âœ… Environment set for Docker + Minikube"
      args:
        executable: /bin/bash

    - name: ğŸ› ï¸ Verify Docker connection
      shell: docker info
      args:
        executable: /bin/bash
      register: docker_info
      ignore_errors: yes

    - name: ğŸ“¦ Build Flask App Docker image
      shell: |
        eval $(minikube docker-env)
        docker build -t flask-app:latest .
      args:
        chdir: "{{ playbook_dir }}/.."
        executable: /bin/bash

    - name: ğŸš€ Apply Kubernetes Deployment
      shell: kubectl apply -f k8s/deployment.yaml
      args:
        chdir: "{{ playbook_dir }}/.."
        executable: /bin/bash

    - name: ğŸ”„ Restart Deployment (ensure latest image)
      shell: kubectl rollout restart deployment flask-app-deployment
      args:
        chdir: "{{ playbook_dir }}/.."
        executable: /bin/bash

    - name: ğŸ” Check Pods
      shell: kubectl get pods -o wide
      args:
        executable: /bin/bash
      register: pod_status

    - name: ğŸŒ Check Services
      shell: kubectl get svc
      args:
        executable: /bin/bash
      register: svc_status

    - name: âœ… Display Summary
      debug:
        msg:
          - "ğŸ“¦ Pods Status:"
          - "{{ pod_status.stdout }}"
          - "ğŸŒ Services Status:"
          - "{{ svc_status.stdout }}"
