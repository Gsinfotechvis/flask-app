---
- name: Full Flask App Deployment on Minikube
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # âœ… Use Windows paths mounted in WSL
    minikube_cmd: "/mnt/c/Program Files/Minikube/minikube.exe"
    docker_host: "tcp://127.0.0.1:49679"
    docker_cert_path: "/mnt/c/Users/DELL/.minikube/certs"
    kubeconfig_path: "/mnt/c/ProgramData/Jenkins/.kube/config"

  tasks:
    - name: ğŸŸ¢ Ensure Minikube is running
      shell: |
        if ! "{{ minikube_cmd }}" status | grep -q "Running"; then
          echo "Starting Minikube..."
          "{{ minikube_cmd }}" start --driver=docker
        else
          echo "âœ… Minikube already running"
        fi
      args:
        executable: /bin/bash
      register: minikube_status
      ignore_errors: yes

    - name: ğŸ§© Export environment variables for Docker & Minikube
      shell: |
        eval $("{{ minikube_cmd }}" docker-env)
        export KUBECONFIG="{{ kubeconfig_path }}"
        echo "âœ… Environment variables set for Docker and Minikube"
      args:
        executable: /bin/bash

    - name: ğŸ› ï¸ Verify Docker connection
      shell: docker info
      args:
        executable: /bin/bash
      register: docker_info
      ignore_errors: yes

    - name: ğŸ“¦ Build Flask App Docker image
      shell: docker build -t flask-app:latest .
      args:
        chdir: "{{ playbook_dir }}/.."
        executable: /bin/bash

    - name: ğŸš€ Apply Kubernetes Deployment
      shell: kubectl apply -f k8s/deployment.yaml
      args:
        chdir: "{{ playbook_dir }}/.."
        executable: /bin/bash

    - name: ğŸ”„ Restart Deployment (ensure latest image)
      shell: kubectl rollout restart deployment flask-app-deployment
      args:
        chdir: "{{ playbook_dir }}/.."
        executable: /bin/bash

    - name: ğŸ” Check Pods
      shell: kubectl get pods -o wide
      args:
        executable: /bin/bash
      register: pod_status

    - name: ğŸŒ Check Services
      shell: kubectl get svc
      args:
        executable: /bin/bash
      register: svc_status

    - name: âœ… Display Summary
      debug:
        msg:
          - "ğŸ“¦ Pods Status:"
          - "{{ pod_status.stdout }}"
          - "ğŸŒ Services Status:"
          - "{{ svc_status.stdout }}"
